<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crush Usage Statistics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg: #201F26;
            --bg-secondary: #2D2C35;
            --text: #F1EFEF;
            --text-muted: #858392;
            --accent: #6B50FF;
            --accent2: #00A4FF;
            --accent3: #00FFB2;
            --accent4: #FF577D;
            --border: #4D4C57;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            padding: 2rem;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            color: var(--accent);
        }
        .subtitle {
            color: var(--text-muted);
            margin-bottom: 2rem;
        }
        .stats-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 2rem;
            width: 100%;
        }
        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            flex: 1 1 150px;
            max-width: calc((100% - 5rem) / 6);
        }
        @media (max-width: 1024px) {
            .stat-card {
                max-width: calc((100% - 2rem) / 3);
            }
        }
        @media (max-width: 600px) {
            .stat-card {
                max-width: calc((100% - 1rem) / 2);
            }
        }
        .stat-card h3 {
            font-size: 0.875rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }
        .stat-card .value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent);
        }
        .stat-card .value.cost {
            color: var(--accent4);
        }
        .charts-grid {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            margin-bottom: 2rem;
            width: 100%;
        }
        .chart-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            width: 100%;
            box-sizing: border-box;
        }
        .chart-card.full-width {
            width: 100%;
        }
        .chart-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            width: 100%;
        }
        .chart-row .chart-card {
            width: 100%;
        }
        @media (max-width: 1024px) {
            .chart-row {
                grid-template-columns: 1fr;
            }
        }
        .chart-card h2 {
            font-size: 1.25rem;
            margin-bottom: 1rem;
            color: var(--text);
        }
        .chart-container {
            position: relative;
            height: 300px;
        }
        .chart-container.tall {
            height: 400px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        th, td {
            text-align: left;
            padding: 0.75rem;
            border-bottom: 1px solid var(--border);
        }
        th {
            color: var(--text-muted);
            font-weight: 500;
            font-size: 0.875rem;
        }
        td {
            font-family: 'SF Mono', Consolas, monospace;
        }
        .model-tag {
            background: var(--bg);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.875rem;
        }
        .footer {
            text-align: center;
            color: var(--text-muted);
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid var(--border);
        }

    </style>
</head>
<body>
    <div class="container">
        <h1>Crush Usage Statistics</h1>
        <p class="subtitle">Generated on <span id="generated-at"></span></p>

        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total Sessions</h3>
                <div class="value" id="total-sessions"></div>
            </div>
            <div class="stat-card">
                <h3>Total Messages</h3>
                <div class="value" id="total-messages"></div>
            </div>
            <div class="stat-card">
                <h3>Total Tokens</h3>
                <div class="value" id="total-tokens"></div>
            </div>
            <div class="stat-card">
                <h3>Total Cost</h3>
                <div class="value cost" id="total-cost"></div>
            </div>
            <div class="stat-card">
                <h3>Tokens/Session</h3>
                <div class="value" id="avg-tokens"></div>
            </div>
            <div class="stat-card">
                <h3>Response Time</h3>
                <div class="value" id="avg-response"></div>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-card full-width">
                <h2>Activity Heatmap</h2>
                <div class="chart-container tall">
                    <canvas id="heatmapChart"></canvas>
                </div>
            </div>

            <div class="chart-card full-width">
                <h2>Activity (Last 30 Days)</h2>
                <div class="chart-container tall">
                    <canvas id="recentActivityChart"></canvas>
                </div>
            </div>

            <div class="chart-row">
                <div class="chart-card">
                    <h2>Tool Usage</h2>
                    <div class="chart-container">
                        <canvas id="toolChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <h2>Token Distribution</h2>
                    <div class="chart-container">
                        <canvas id="tokenPieChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="chart-card full-width">
                <h2>Usage by Model</h2>
                <div class="chart-container tall">
                    <canvas id="modelChart"></canvas>
                </div>
            </div>

            <div class="chart-card full-width">
                <h2>Daily Usage History</h2>
                <table id="daily-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Sessions</th>
                            <th>Prompt Tokens</th>
                            <th>Completion Tokens</th>
                            <th>Total Tokens</th>
                            <th>Cost</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div class="footer">
            <p>Generated by Crush</p>
        </div>
    </div>

    <script>
        const stats = {{.StatsJSON}};

        // Helper functions
        function formatNumber(n) {
            return new Intl.NumberFormat().format(Math.round(n));
        }

        function formatCompact(n) {
            if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
            if (n >= 1000) return (n / 1000).toFixed(1) + 'k';
            return Math.round(n).toString();
        }

        function formatCost(n) {
            return '$' + n.toFixed(2);
        }

        function formatTime(ms) {
            if (ms < 1000) return Math.round(ms) + 'ms';
            return (ms / 1000).toFixed(1) + 's';
        }

        // Populate summary cards
        document.getElementById('generated-at').textContent = new Date(stats.generated_at).toLocaleString();
        document.getElementById('total-sessions').textContent = formatNumber(stats.total.total_sessions);
        document.getElementById('total-messages').textContent = formatCompact(stats.total.total_messages);
        document.getElementById('total-tokens').textContent = formatCompact(stats.total.total_tokens);
        document.getElementById('total-cost').textContent = formatCost(stats.total.total_cost);
        document.getElementById('avg-tokens').innerHTML = '<span title="Average">x̅</span> ' + formatCompact(stats.total.avg_tokens_per_session);
        document.getElementById('avg-response').innerHTML = '<span title="Average">x̅</span> ' + formatTime(stats.avg_response_time_ms);

        // Chart defaults
        Chart.defaults.color = '#F1EFEF';
        Chart.defaults.borderColor = '#4D4C57';

        // Recent Activity Chart
        if (stats.recent_activity && stats.recent_activity.length > 0) {
            new Chart(document.getElementById('recentActivityChart'), {
                type: 'bar',
                data: {
                    labels: stats.recent_activity.map(d => d.day),
                    datasets: [{
                        label: 'Sessions',
                        data: stats.recent_activity.map(d => d.session_count),
                        backgroundColor: '#6B50FF',
                        borderRadius: 4,
                        yAxisID: 'y'
                    }, {
                        label: 'Tokens (K)',
                        data: stats.recent_activity.map(d => d.total_tokens / 1000),
                        type: 'line',
                        borderColor: '#00A4FF',
                        backgroundColor: 'transparent',
                        tension: 0.3,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        y: { position: 'left', title: { display: true, text: 'Sessions' } },
                        y1: { position: 'right', title: { display: true, text: 'Tokens (K)' }, grid: { drawOnChartArea: false } }
                    }
                }
            });
        }

        // Heatmap (Hour × Day of Week) - Bubble Chart
        const dayLabels = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

        if (stats.hour_day_heatmap && stats.hour_day_heatmap.length > 0) {
            let maxCount = Math.max(...stats.hour_day_heatmap.map(h => h.session_count));
            if (maxCount === 0) maxCount = 1;
            const scaleFactor = 20 / Math.sqrt(maxCount);

            new Chart(document.getElementById('heatmapChart'), {
                type: 'bubble',
                data: {
                    datasets: [{
                        label: 'Sessions',
                        data: stats.hour_day_heatmap.filter(h => h.session_count > 0).map(h => ({
                            x: h.hour,
                            y: h.day_of_week,
                            r: Math.sqrt(h.session_count) * scaleFactor,
                            count: h.session_count
                        })),
                        backgroundColor: 'rgba(107, 80, 255, 0.6)',
                        borderColor: 'rgba(107, 80, 255, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            min: 0,
                            max: 23,
                            grid: { display: false },
                            title: { display: true, text: 'Hour of Day' },
                            ticks: { stepSize: 1, callback: v => Number.isInteger(v) ? v : '' }
                        },
                        y: {
                            min: 0,
                            max: 6,
                            reverse: true,
                            grid: { display: false },
                            title: { display: true, text: 'Day of Week' },
                            ticks: { stepSize: 1, callback: v => dayLabels[v] || '' }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: ctx => dayLabels[ctx.raw.y] + ' ' + ctx.raw.x + ':00 - ' + ctx.raw.count + ' sessions'
                            }
                        }
                    }
                }
            });
        }

        // Tool Usage Chart
        if (stats.tool_usage && stats.tool_usage.length > 0) {
            const toolColors = ['#6B50FF', '#00A4FF', '#00FFB2', '#FF577D', '#FF388B', '#E8FF27', '#12C78F', '#FF985A', '#F379FF', '#858392'];
            new Chart(document.getElementById('toolChart'), {
                type: 'bar',
                data: {
                    labels: stats.tool_usage.slice(0, 15).map(t => t.tool_name),
                    datasets: [{
                        label: 'Calls',
                        data: stats.tool_usage.slice(0, 15).map(t => t.call_count),
                        backgroundColor: toolColors,
                        borderRadius: 4
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });
        }

        // Token Distribution Pie
        new Chart(document.getElementById('tokenPieChart'), {
            type: 'doughnut',
            data: {
                labels: ['Prompt Tokens', 'Completion Tokens'],
                datasets: [{
                    data: [stats.total.total_prompt_tokens, stats.total.total_completion_tokens],
                    backgroundColor: ['#6B50FF', '#00A4FF']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });

        // Model Usage Chart (horizontal bar)
        if (stats.usage_by_model && stats.usage_by_model.length > 0) {
            const modelColors = ['#6B50FF', '#00A4FF', '#00FFB2', '#FF577D', '#FF388B', '#E8FF27', '#12C78F', '#FF985A', '#F379FF', '#858392'];
            new Chart(document.getElementById('modelChart'), {
                type: 'bar',
                data: {
                    labels: stats.usage_by_model.map(m => m.model + ' (' + m.provider + ')'),
                    datasets: [{
                        label: 'Messages',
                        data: stats.usage_by_model.map(m => m.message_count),
                        backgroundColor: modelColors.slice(0, stats.usage_by_model.length),
                        borderRadius: 4
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });
        }

        // Daily Usage Table
        const tableBody = document.querySelector('#daily-table tbody');
        stats.usage_by_day?.slice(0, 30).forEach(d => {
            const row = document.createElement('tr');
            row.innerHTML = '<td>' + d.day + '</td>' +
                '<td>' + d.session_count + '</td>' +
                '<td>' + formatNumber(d.prompt_tokens) + '</td>' +
                '<td>' + formatNumber(d.completion_tokens) + '</td>' +
                '<td>' + formatNumber(d.total_tokens) + '</td>' +
                '<td>' + formatCost(d.cost) + '</td>';
            tableBody.appendChild(row);
        });
    </script>
</body>
</html>
