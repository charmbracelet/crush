<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crush Usage Statistics</title>
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            /* Dark mode colors - charmtone dark palette */
            --bg: #201F26;
            --bg-secondary: #2D2C35;
            --text: #FFFAF1;
            --text-muted: #858392;
            --accent: #6B50FF;
            --accent2: #00A4FF;
            --accent3: #00FFB2;
            --accent4: #FF577D;
            --border: #4D4C57;
            /* Charmtone colors (global - same in both light and dark modes) */
            --charple: #6B50FF;
            --cherry: #FF388B;
            --julep: #00FFB2;
            --urchin: #C337E0;
            --butter: #FFFAF1;
            --squid: #858392;
            --pepper: #201F26;
            --iron: #4D4C57;
        }

        /* Light mode colors - charmtone light palette */
        @media (prefers-color-scheme: light) {
            :root {
                --bg: #F0F0F0;
                --bg-secondary: #FBFBFB;
                --text: #201F26;
                --text-muted: #4D4C57;
                --accent: #644CED;
                --accent2: #0096FF;
                --accent3: #00E0C3;
                --accent4: #FF6384;
                --border: #E8E6EB;
            }
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            padding: 2rem 0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header-wrapper {
            max-width: 1200px;
            margin: 0 auto 2rem;
        }
        .header-wrapper svg {
            width: 100%;
            height: auto;
            display: block;
        }
        .header-light {
            display: none;
        }
        .footer-light {
            display: none;
        }
        @media (prefers-color-scheme: light) {
            .header-dark {
                display: none;
            }
            .header-light {
                display: block;
            }
            .footer-dark {
                display: none;
            }
            .footer-light {
                display: block;
            }
        }
        .stats-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 2rem;
            width: 100%;
        }
        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            flex: 1 1 150px;
            max-width: calc((100% - 5rem) / 6);
        }
        @media (max-width: 1024px) {
            .stat-card {
                max-width: calc((100% - 2rem) / 3);
            }
        }
        @media (max-width: 600px) {
            .stat-card {
                max-width: calc((100% - 1rem) / 2);
            }
        }
        .stat-card h3 {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }
        .stat-card .value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--butter);
            white-space: nowrap;
        }
        @media (prefers-color-scheme: light) {
            .stat-card .value {
                color: var(--pepper);
            }
        }
        .charts-grid {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            margin-bottom: 2rem;
            width: 100%;
        }
        .chart-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            width: 100%;
            box-sizing: border-box;
        }
        .chart-card.full-width {
            width: 100%;
        }
        .chart-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            width: 100%;
        }
        .chart-row .chart-card {
            width: 100%;
        }
        @media (max-width: 1024px) {
            .chart-row {
                grid-template-columns: 1fr;
            }
        }
        .chart-card h2 {
            font-size: 1.25rem;
            margin-bottom: 1rem;
            color: var(--text);
        }
        .chart-container {
            position: relative;
            height: 300px;
        }
        .chart-container.tall {
            height: 400px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        th, td {
            text-align: left;
            padding: 0.75rem;
            border-bottom: 1px solid var(--border);
        }
        th {
            color: var(--text-muted);
            font-weight: 500;
            font-size: 0.875rem;
        }
        td {
            font-family: 'SF Mono', Consolas, monospace;
        }
        .model-tag {
            background: var(--bg);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.875rem;
        }
        .footer-container {
            max-width: 1200px;
            margin: 2rem auto 0;
            padding-top: 2rem;
        }
        .footer-container svg {
            width: 100%;
            height: auto;
            display: block;
        }

    </style>
</head>
<body>
    <div class="container">
        <div class="header-wrapper">
            <div class="header-dark">{{.HeaderDark}}</div>
            <div class="header-light">{{.HeaderLight}}</div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total Sessions</h3>
                <div class="value" id="total-sessions"></div>
            </div>
            <div class="stat-card">
                <h3>Total Messages</h3>
                <div class="value" id="total-messages"></div>
            </div>
            <div class="stat-card">
                <h3>Total Tokens</h3>
                <div class="value" id="total-tokens"></div>
            </div>
            <div class="stat-card">
                <h3>Total Cost</h3>
                <div class="value cost" id="total-cost"></div>
            </div>
            <div class="stat-card">
                <h3>Tokens/Session</h3>
                <div class="value" id="avg-tokens"></div>
            </div>
            <div class="stat-card">
                <h3>Response Time</h3>
                <div class="value" id="avg-response"></div>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-card full-width">
                <h2>Activity Heatmap</h2>
                <div class="chart-container tall">
                    <canvas id="heatmapChart"></canvas>
                </div>
            </div>

            <div class="chart-card full-width">
                <h2>Activity (Last 30 Days)</h2>
                <div class="chart-container tall">
                    <canvas id="recentActivityChart"></canvas>
                </div>
            </div>

            <div class="chart-card full-width">
                <h2>Tool Usage</h2>
                <div class="chart-container tall">
                    <canvas id="toolChart"></canvas>
                </div>
            </div>

            <div class="chart-row">
                <div class="chart-card">
                    <h2>Messages by Provider</h2>
                    <div class="chart-container">
                        <canvas id="providerPieChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <h2>Token Distribution</h2>
                    <div class="chart-container">
                        <canvas id="tokenPieChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="chart-card full-width">
                <h2>Usage by Model</h2>
                <div class="chart-container tall">
                    <canvas id="modelChart"></canvas>
                </div>
            </div>

            <div class="chart-card full-width">
                <h2>Daily Usage History</h2>
                <div style="overflow-x: auto;">
                    <table id="daily-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Sessions</th>
                                <th>Prompt Tokens</th>
                                <th>Completion Tokens</th>
                                <th>Total Tokens</th>
                                <th>Cost</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="footer-container">
            <div class="footer-dark">{{.FooterDark}}</div>
            <div class="footer-light">{{.FooterLight}}</div>
        </div>
    </div>

    <script>
        const stats = {{.StatsJSON}};

        // Get all charmtone colors once from computed styles
        const rootStyles = getComputedStyle(document.documentElement);
        const colors = {
            charple: rootStyles.getPropertyValue('--charple').trim(),
            cherry: rootStyles.getPropertyValue('--cherry').trim(),
            julep: rootStyles.getPropertyValue('--julep').trim(),
            urchin: rootStyles.getPropertyValue('--urchin').trim(),
            butter: rootStyles.getPropertyValue('--butter').trim(),
            squid: rootStyles.getPropertyValue('--squid').trim(),
            pepper: rootStyles.getPropertyValue('--pepper').trim(),
        };

        // Helper functions
        function formatNumber(n) {
            return new Intl.NumberFormat().format(Math.round(n));
        }

        function formatCompact(n) {
            if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
            if (n >= 1000) return (n / 1000).toFixed(1) + 'k';
            return Math.round(n).toString();
        }

        function formatCost(n) {
            return '$' + n.toFixed(2);
        }

        function formatTime(ms) {
            if (ms < 1000) return Math.round(ms) + 'ms';
            return (ms / 1000).toFixed(1) + 's';
        }

        // Populate summary cards
        document.getElementById('total-sessions').textContent = formatNumber(stats.total.total_sessions);
        document.getElementById('total-messages').textContent = formatCompact(stats.total.total_messages);
        document.getElementById('total-tokens').textContent = formatCompact(stats.total.total_tokens);
        document.getElementById('total-cost').textContent = formatCost(stats.total.total_cost);
        document.getElementById('avg-tokens').innerHTML = '<span title="Average">x̅</span> ' + formatCompact(stats.total.avg_tokens_per_session);
        document.getElementById('avg-response').innerHTML = '<span title="Average">x̅</span> ' + formatTime(stats.avg_response_time_ms);

        // Chart defaults
        Chart.defaults.color = colors.squid;
        Chart.defaults.borderColor = colors.squid;

        if (stats.recent_activity?.length > 0) {
            new Chart(document.getElementById('recentActivityChart'), {
                type: 'bar',
                data: {
                    labels: stats.recent_activity.map(d => d.day),
                    datasets: [{
                        label: 'Sessions',
                        data: stats.recent_activity.map(d => d.session_count),
                        backgroundColor: colors.charple,
                        borderRadius: 4,
                        yAxisID: 'y'
                    }, {
                        label: 'Tokens (K)',
                        data: stats.recent_activity.map(d => d.total_tokens / 1000),
                        backgroundColor: colors.julep,
                        borderRadius: 4,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        y: { position: 'left', title: { display: true, text: 'Sessions' } },
                        y1: { position: 'right', title: { display: true, text: 'Tokens (K)' }, grid: { drawOnChartArea: false } }
                    }
                }
            });
        }

        // Heatmap (Hour × Day of Week) - Bubble Chart
        const dayLabels = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

        if (stats.hour_day_heatmap?.length > 0) {
            let maxCount = Math.max(...stats.hour_day_heatmap.map(h => h.session_count));
            if (maxCount === 0) maxCount = 1;
            const scaleFactor = 20 / Math.sqrt(maxCount);

            new Chart(document.getElementById('heatmapChart'), {
                type: 'bubble',
                data: {
                    datasets: [{
                        label: 'Sessions',
                        data: stats.hour_day_heatmap.filter(h => h.session_count > 0).map(h => ({
                            x: h.hour,
                            y: h.day_of_week,
                            r: Math.sqrt(h.session_count) * scaleFactor,
                            count: h.session_count
                        })),
                        backgroundColor: ctx => {
                            const count = ctx.raw?.count || ctx.dataset.data[ctx.dataIndex]?.count || 0;
                            const ratio = count / maxCount;
                            const color = ratio > 0.5 ? colors.cherry : colors.charple;
                            return color + '99';
                        },
                        borderColor: ctx => {
                            const count = ctx.raw?.count || ctx.dataset.data[ctx.dataIndex]?.count || 0;
                            const ratio = count / maxCount;
                            return ratio > 0.5 ? colors.cherry : colors.charple;
                        },
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            min: 0,
                            max: 23,
                            grid: { display: false },
                            title: { display: true, text: 'Hour of Day' },
                            ticks: { stepSize: 1, callback: v => Number.isInteger(v) ? v : '' }
                        },
                        y: {
                            min: 0,
                            max: 6,
                            reverse: true,
                            grid: { display: false },
                            title: { display: true, text: 'Day of Week' },
                            ticks: { stepSize: 1, callback: v => dayLabels[v] || '' }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: ctx => dayLabels[ctx.raw.y] + ' ' + ctx.raw.x + ':00 - ' + ctx.raw.count + ' sessions'
                            }
                        }
                    }
                }
            });
        }

        if (stats.tool_usage?.length > 0) {
            const third = Math.floor(stats.tool_usage.length / 3);
            const toolColors = stats.tool_usage.map((_, i) =>
                i < third ? colors.charple : i < third * 2 ? colors.urchin : colors.cherry
            );
            new Chart(document.getElementById('toolChart'), {
                type: 'bar',
                data: {
                    labels: stats.tool_usage.map(t => t.tool_name),
                    datasets: [{
                        label: 'Calls',
                        data: stats.tool_usage.map(t => t.call_count),
                        backgroundColor: toolColors,
                        borderRadius: 4
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });
        }

        // Token Distribution Pie
        new Chart(document.getElementById('tokenPieChart'), {
            type: 'doughnut',
            data: {
                labels: ['Prompt Tokens', 'Completion Tokens'],
                datasets: [{
                    data: [stats.total.total_prompt_tokens, stats.total.total_completion_tokens],
                    backgroundColor: [colors.charple, colors.julep]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });

        // Model Usage Chart (horizontal bar)
        if (stats.usage_by_model?.length > 0) {
            new Chart(document.getElementById('modelChart'), {
                type: 'bar',
                data: {
                    labels: stats.usage_by_model.map(m => `${m.model} (${m.provider})`),
                    datasets: [{
                        label: 'Messages',
                        data: stats.usage_by_model.map(m => m.message_count),
                        backgroundColor: ctx => {
                            const bar = ctx.raw;
                            const chart = ctx.chart;
                            const { ctx: chartCtx, chartArea: rect } = chart;
                            if (!rect || !bar) return colors.charple;
                            const gradient = chartCtx.createLinearGradient(rect.left, 0, rect.right, 0);
                            gradient.addColorStop(0, colors.charple);
                            gradient.addColorStop(1, colors.cherry);
                            return gradient;
                        },
                        borderRadius: 4
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });
        }

        if (stats.usage_by_model?.length > 0) {
            const providerData = stats.usage_by_model.reduce((acc, m) => {
                acc[m.provider] = (acc[m.provider] || 0) + m.message_count;
                return acc;
            }, {});
            const providerColors = [colors.charple, colors.julep, colors.urchin, colors.cherry];
            new Chart(document.getElementById('providerPieChart'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(providerData),
                    datasets: [{
                        data: Object.values(providerData),
                        backgroundColor: Object.keys(providerData).map((_, i) => providerColors[i % providerColors.length])
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        // Daily Usage Table
        const tableBody = document.querySelector('#daily-table tbody');
        if (stats.usage_by_day?.length > 0) {
            const fragment = document.createDocumentFragment();
            stats.usage_by_day.slice(0, 30).forEach(d => {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${d.day}</td><td>${d.session_count}</td><td>${formatNumber(d.prompt_tokens)}</td><td>${formatNumber(d.completion_tokens)}</td><td>${formatNumber(d.total_tokens)}</td><td>${formatCost(d.cost)}</td>`;
                fragment.appendChild(row);
            });
            tableBody.appendChild(fragment);
        }
    </script>
</body>
</html>
